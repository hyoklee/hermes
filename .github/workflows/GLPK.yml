name: GLPK
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: Get Sources
        uses: actions/checkout@v2
      - name: Checkout Spack
        uses: actions/checkout@v2
        with:
          repository: hyoklee/spack
          path: ./spack
      - name: Install APT Dependencies
        run: |
          sudo apt update
          sudo apt-get install -y autoconf
          sudo apt-get install -y automake
          sudo apt-get install -y cmake
          sudo apt-get install -y libtool
          sudo apt-get install -y libtool-bin
          sudo apt-get install -y mpich
          sudo apt-get install -y lcov
          sudo apt-get install -y zlib1g-dev
          sudo apt-get install -y libsdl2-dev
          sudo apt-get install -y diffutils
          sudo apt-get install -y libdb-dev
          sudo apt-get install -y libedit-dev
          sudo apt-get install -y libncurses6
          sudo apt-get install -y libsigsegv-dev
          sudo apt-get install -y libxml2-dev
          sudo apt-get install -y mpich
          sudo apt-get install -y openssl
          sudo apt-get install -y xz-utils

      - name: Run Spack
        run: |
          pip install clingo
          . ./spack/share/spack/setup-env.sh
          spack compiler find
          spack external find autoconf
          spack external find automake
          spack external find berkeley-db
          spack external find boost
          spack external find catch2
          spack external find cmake
          spack external find diffutils
          spack external find libedit
          spack external find libtool
          spack external find libiconv
          spack external find libfabric
          spack external find libsigsegv
          spack external find libxml2
          spack external find m4
          spack external find mpich
          spack external find ncurses
          spack external find openssl
          spack external find perl
          spack external find pkgconf
          spack external find zlib
          spack external find xz
          spack install glpk
          spack load glpk
          spack install mochi-thallium~cereal
          spack load mochi-thallium~cereal
          spack install cereal
          spack load cereal
          spack install glog
          spack load glog
          ci/install_hermes_glpk.sh
          pushd ci/cluster && ./multi_node_ci_test.sh
